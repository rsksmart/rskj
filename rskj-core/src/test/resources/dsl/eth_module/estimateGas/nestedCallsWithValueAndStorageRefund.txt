comment
compiled using solidity: "0.7.3"

pragma solidity >=0.6.0 <0.9.0;

contract NestedCallsWithValueAndStorageRefund {
    address payable nextAddress;
    bool lastCall = false;
    mapping(uint256 => uint256) public values;

    event NestedCallWV();
    event LastCall();

    constructor() {
        values[1] = 42;
        values[2] = 42;
        values[3] = 42;
        values[4] = 42;
        values[5] = 42;
    }

    fallback () external payable { }

    function callAddressWithValue() public payable {
        if(!lastCall) {
            NestedCallsWithValueAndStorageRefund(nextAddress).callAddressWithValue{value: msg.value, gas: gasleft() - 10000}();
            emit NestedCallWV();
        } else {
            values[1] = 0;
            values[2] = 0;
            values[3] = 0;
            values[4] = 0;
            values[5] = 0;
            payable(this).transfer(msg.value);
            emit LastCall();
        }
    }

    function setNextAddress(address payable n) public {
        nextAddress = n;
    }

    function setLastCall() public {
        lastCall = true;
    }
}
end

account_new acc1 20000000

# Deploy three instances of NestedCallsWithValueAndStorageRefund

transaction_build tx01
    sender acc1
    nonce 0
    receiverAddress 00
    value 0
    data 608060405260008060146101000a81548160ff02191690831515021790555034801561002a57600080fd5b50602a600160006001815260200190815260200160002081905550602a600160006002815260200190815260200160002081905550602a600160006003815260200190815260200160002081905550602a600160006004815260200190815260200160002081905550602a60016000600581526020019081526020016000208190555061037a806100bc6000396000f3fe6080604052600436106100435760003560e01c80633aecee24146100465780635e383d211461005d578063ba264735146100ac578063fb60f709146100fd57610044565b5b005b34801561005257600080fd5b5061005b610107565b005b34801561006957600080fd5b506100966004803603602081101561008057600080fd5b8101908080359060200190929190505050610124565b6040518082815260200191505060405180910390f35b3480156100b857600080fd5b506100fb600480360360208110156100cf57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061013c565b005b61010561017f565b005b6001600060146101000a81548160ff021916908315150217905550565b60016020528060005260406000206000915090505481565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600060149054906101000a900460ff1661024c5760008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fb60f709346127105a03906040518363ffffffff1660e01b81526004016000604051808303818589803b15801561020157600080fd5b5088f1158015610215573d6000803e3d6000fd5b5050505050507fde0f1ac890b93f05f29eb21d0298f6bf3b9954213c196fefecdb445b4ed047a560405160405180910390a1610342565b600060016000600181526020019081526020016000208190555060006001600060028152602001908152602001600020819055506000600160006003815260200190815260200160002081905550600060016000600481526020019081526020016000208190555060006001600060058152602001908152602001600020819055503073ffffffffffffffffffffffffffffffffffffffff166108fc349081150290604051600060405180830381858888f19350505050158015610314573d6000803e3d6000fd5b507faf10f11658b97bcc0ed656fdfe4e20ca91e4a2a150f363233da11ec1d4898a4760405160405180910390a15b56fea2646970667358221220597bb4cb03e45f2e30e7bec4738d5b1056f3f8f5156d8fd74ef927091ce7968d64736f6c63430007030033
    gas 1000000
    build

transaction_build tx02
    sender acc1
    nonce 1
    receiverAddress 00
    value 0
    data 608060405260008060146101000a81548160ff02191690831515021790555034801561002a57600080fd5b50602a600160006001815260200190815260200160002081905550602a600160006002815260200190815260200160002081905550602a600160006003815260200190815260200160002081905550602a600160006004815260200190815260200160002081905550602a60016000600581526020019081526020016000208190555061037a806100bc6000396000f3fe6080604052600436106100435760003560e01c80633aecee24146100465780635e383d211461005d578063ba264735146100ac578063fb60f709146100fd57610044565b5b005b34801561005257600080fd5b5061005b610107565b005b34801561006957600080fd5b506100966004803603602081101561008057600080fd5b8101908080359060200190929190505050610124565b6040518082815260200191505060405180910390f35b3480156100b857600080fd5b506100fb600480360360208110156100cf57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061013c565b005b61010561017f565b005b6001600060146101000a81548160ff021916908315150217905550565b60016020528060005260406000206000915090505481565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600060149054906101000a900460ff1661024c5760008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fb60f709346127105a03906040518363ffffffff1660e01b81526004016000604051808303818589803b15801561020157600080fd5b5088f1158015610215573d6000803e3d6000fd5b5050505050507fde0f1ac890b93f05f29eb21d0298f6bf3b9954213c196fefecdb445b4ed047a560405160405180910390a1610342565b600060016000600181526020019081526020016000208190555060006001600060028152602001908152602001600020819055506000600160006003815260200190815260200160002081905550600060016000600481526020019081526020016000208190555060006001600060058152602001908152602001600020819055503073ffffffffffffffffffffffffffffffffffffffff166108fc349081150290604051600060405180830381858888f19350505050158015610314573d6000803e3d6000fd5b507faf10f11658b97bcc0ed656fdfe4e20ca91e4a2a150f363233da11ec1d4898a4760405160405180910390a15b56fea2646970667358221220597bb4cb03e45f2e30e7bec4738d5b1056f3f8f5156d8fd74ef927091ce7968d64736f6c63430007030033
    gas 1000000
    build

transaction_build tx03
    sender acc1
    nonce 2
    receiverAddress 00
    value 0
    data 608060405260008060146101000a81548160ff02191690831515021790555034801561002a57600080fd5b50602a600160006001815260200190815260200160002081905550602a600160006002815260200190815260200160002081905550602a600160006003815260200190815260200160002081905550602a600160006004815260200190815260200160002081905550602a60016000600581526020019081526020016000208190555061037a806100bc6000396000f3fe6080604052600436106100435760003560e01c80633aecee24146100465780635e383d211461005d578063ba264735146100ac578063fb60f709146100fd57610044565b5b005b34801561005257600080fd5b5061005b610107565b005b34801561006957600080fd5b506100966004803603602081101561008057600080fd5b8101908080359060200190929190505050610124565b6040518082815260200191505060405180910390f35b3480156100b857600080fd5b506100fb600480360360208110156100cf57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061013c565b005b61010561017f565b005b6001600060146101000a81548160ff021916908315150217905550565b60016020528060005260406000206000915090505481565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600060149054906101000a900460ff1661024c5760008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fb60f709346127105a03906040518363ffffffff1660e01b81526004016000604051808303818589803b15801561020157600080fd5b5088f1158015610215573d6000803e3d6000fd5b5050505050507fde0f1ac890b93f05f29eb21d0298f6bf3b9954213c196fefecdb445b4ed047a560405160405180910390a1610342565b600060016000600181526020019081526020016000208190555060006001600060028152602001908152602001600020819055506000600160006003815260200190815260200160002081905550600060016000600481526020019081526020016000208190555060006001600060058152602001908152602001600020819055503073ffffffffffffffffffffffffffffffffffffffff166108fc349081150290604051600060405180830381858888f19350505050158015610314573d6000803e3d6000fd5b507faf10f11658b97bcc0ed656fdfe4e20ca91e4a2a150f363233da11ec1d4898a4760405160405180910390a15b56fea2646970667358221220597bb4cb03e45f2e30e7bec4738d5b1056f3f8f5156d8fd74ef927091ce7968d64736f6c63430007030033
    gas 1000000
    build

block_build b01
    parent g00
    transactions tx01 tx02 tx03
    build

block_connect b01
assert_best b01

# init next address 56aa252dd82173789984fa164ee26ce2da9336ff
transaction_build tx04
    sender acc1
    nonce 3
    receiverAddress 6252703f5ba322ec64d3ac45e56241b7d9e481ad
    data ba26473500000000000000000000000056aa252dd82173789984fa164ee26ce2da9336ff
    gas 1000000
    build

# init next address 27444fbce96cb2d27b94e116d1506d7739c05862
transaction_build tx05
    sender acc1
    nonce 4
    receiverAddress 56aa252dd82173789984fa164ee26ce2da9336ff
    data ba26473500000000000000000000000027444fbce96cb2d27b94e116d1506d7739c05862
    gas 1000000
    build

# init last call
transaction_build tx06
    sender acc1
    nonce 5
    receiverAddress 27444fbce96cb2d27b94e116d1506d7739c05862
    data 3aecee24
    gas 1000000
    build

block_build b02
    parent b01
    transactions tx04 tx05 tx06
    build

block_connect b02
assert_best b02

