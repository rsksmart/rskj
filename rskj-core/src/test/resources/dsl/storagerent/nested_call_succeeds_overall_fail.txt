# acc1 = "0xa0663f719962ec10bb57865532bef522059dfd96"
account_new acc1 20000000

# StorageRentA = "0x6252703f5ba322ec64d3ac45e56241b7d9e481ad"
# StorageRentB = "0x56aa252dd82173789984fa164ee26ce2da9336ff"

# Contract deploy StorageRent (instance1), now called StorageRentA
transaction_build tx01
    sender acc1
    nonce 0
    receiver 00
    gas 1000000
    data 608060405234801561001057600080fd5b50600060018190555061089f806100286000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c80633fd1b8b5116100665780633fd1b8b5146100d45780637a8501ba146100f05780638412e667146100fa57806397b5fd2b14610104578063fd0285511461010e57610093565b80630169c9681461009857806329e94367146100a25780632c89aa32146100ac5780633fa4f245146100b6575b600080fd5b6100a0610118565b005b6100aa6101a2565b005b6100b4610234565b005b6100be61033e565b6040516100cb919061074a565b60405180910390f35b6100ee60048036038101906100e99190610640565b610344565b005b6100f8610387565b005b61010261058c565b005b61010c6105ad565b005b6101166105f0565b005b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638412e6676040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561018057600080fd5b505af1158015610194573d6000803e3d6000fd5b505050506101a061058c565b565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638412e6676040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561020a57600080fd5b505af115801561021e573d6000803e3d6000fd5b5050505061022a61058c565b6102326105f0565b565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638412e6676040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561029c57600080fd5b505af11580156102b0573d6000803e3d6000fd5b5050505060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fd0285516040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561031c57600080fd5b505af1158015610330573d6000803e3d6000fd5b5050505061033c61058c565b565b60015481565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638412e6676040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156103ef57600080fd5b505af1158015610403573d6000803e3d6000fd5b5050505060008060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166123286040516024016040516020818303038152906040527f97b5fd2b000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516104d491906106f3565b60006040518083038160008787f1925050503d8060008114610512576040519150601f19603f3d011682016040523d82523d6000602084013e610517565b606091505b50915091508115610553577fd4c1379b05055358f3fa6e4ccdfedb07a73d2b3698e95c42d8dc5838961737e360405160405180910390a1610580565b7f674ac132b884dbf2c6aa45c8cff320fbcdce2ca4813dd0cc56f178c10016153a60405160405180910390a15b61058861058c565b5050565b6001805414156105a35760006001819055506105ab565b600180819055505b565b6105b561058c565b6040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105e79061072a565b60405180910390fd5b6040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106229061070a565b60405180910390fd5b60008135905061063a81610852565b92915050565b600060208284031215610656576106556107fb565b5b60006106648482850161062b565b91505092915050565b600061067882610765565b6106828185610770565b93506106928185602086016107c8565b80840191505092915050565b60006106ab600e8361077b565b91506106b682610800565b602082019050919050565b60006106ce60178361077b565b91506106d982610829565b602082019050919050565b6106ed816107be565b82525050565b60006106ff828461066d565b915081905092915050565b600060208201905081810360008301526107238161069e565b9050919050565b60006020820190508181036000830152610743816106c1565b9050919050565b600060208201905061075f60008301846106e4565b92915050565b600081519050919050565b600081905092915050565b600082825260208201905092915050565b60006107978261079e565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b838110156107e65780820151818401526020810190506107cb565b838111156107f5576000848401525b50505050565b600080fd5b7f7472696767657220726576657274000000000000000000000000000000000000600082015250565b7f6368616e676520737461746520616e6420726576657274000000000000000000600082015250565b61085b8161078c565b811461086657600080fd5b5056fea26469706673582212207fd320df1e0e1877cafff8804124f661612ba7fbb072d6746020eeb226cf480464736f6c63430008070033
    build

# Contract deploy StorageRent (instance2), now called StorageRentB
transaction_build tx02
    sender acc1
    nonce 1
    receiver 00
    gas 1000000
    data 608060405234801561001057600080fd5b50600060018190555061089f806100286000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c80633fd1b8b5116100665780633fd1b8b5146100d45780637a8501ba146100f05780638412e667146100fa57806397b5fd2b14610104578063fd0285511461010e57610093565b80630169c9681461009857806329e94367146100a25780632c89aa32146100ac5780633fa4f245146100b6575b600080fd5b6100a0610118565b005b6100aa6101a2565b005b6100b4610234565b005b6100be61033e565b6040516100cb919061074a565b60405180910390f35b6100ee60048036038101906100e99190610640565b610344565b005b6100f8610387565b005b61010261058c565b005b61010c6105ad565b005b6101166105f0565b005b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638412e6676040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561018057600080fd5b505af1158015610194573d6000803e3d6000fd5b505050506101a061058c565b565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638412e6676040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561020a57600080fd5b505af115801561021e573d6000803e3d6000fd5b5050505061022a61058c565b6102326105f0565b565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638412e6676040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561029c57600080fd5b505af11580156102b0573d6000803e3d6000fd5b5050505060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fd0285516040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561031c57600080fd5b505af1158015610330573d6000803e3d6000fd5b5050505061033c61058c565b565b60015481565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638412e6676040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156103ef57600080fd5b505af1158015610403573d6000803e3d6000fd5b5050505060008060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166123286040516024016040516020818303038152906040527f97b5fd2b000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516104d491906106f3565b60006040518083038160008787f1925050503d8060008114610512576040519150601f19603f3d011682016040523d82523d6000602084013e610517565b606091505b50915091508115610553577fd4c1379b05055358f3fa6e4ccdfedb07a73d2b3698e95c42d8dc5838961737e360405160405180910390a1610580565b7f674ac132b884dbf2c6aa45c8cff320fbcdce2ca4813dd0cc56f178c10016153a60405160405180910390a15b61058861058c565b5050565b6001805414156105a35760006001819055506105ab565b600180819055505b565b6105b561058c565b6040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105e79061072a565b60405180910390fd5b6040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106229061070a565b60405180910390fd5b60008135905061063a81610852565b92915050565b600060208284031215610656576106556107fb565b5b60006106648482850161062b565b91505092915050565b600061067882610765565b6106828185610770565b93506106928185602086016107c8565b80840191505092915050565b60006106ab600e8361077b565b91506106b682610800565b602082019050919050565b60006106ce60178361077b565b91506106d982610829565b602082019050919050565b6106ed816107be565b82525050565b60006106ff828461066d565b915081905092915050565b600060208201905081810360008301526107238161069e565b9050919050565b60006020820190508181036000830152610743816106c1565b9050919050565b600060208201905061075f60008301846106e4565b92915050565b600081519050919050565b600081905092915050565b600082825260208201905092915050565b60006107978261079e565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b838110156107e65780820151818401526020810190506107cb565b838111156107f5576000848401525b50505050565b600080fd5b7f7472696767657220726576657274000000000000000000000000000000000000600082015250565b7f6368616e676520737461746520616e6420726576657274000000000000000000600082015250565b61085b8161078c565b811461086657600080fd5b5056fea26469706673582212207fd320df1e0e1877cafff8804124f661612ba7fbb072d6746020eeb226cf480464736f6c63430008070033
    build

# Set StorageRentB to StorageRentA
transaction_build tx03
    sender acc1
    nonce 2
    contract tx01 # created in tx01
    gas 1000000
    data 3fd1b8b500000000000000000000000056aa252dd82173789984fa164ee26ce2da9336ff
    build

block_build b01
    parent g00
    transactions tx01 tx02 tx03
    gasLimit 6800000
    build

block_connect b01
assert_best b01
assert_tx_success tx01
assert_tx_success tx02
assert_tx_success tx03

# start nested calls from StorageRentA to StorageRentB
transaction_build tx04
    sender acc1
    nonce 3
    contract tx01 # created in tx01
    gas 1000000
    data 29e94367 # nestedCallSuccessOveralFails()
    build

block_build b02
    parent b01
    transactions tx04
    gasLimit 6800000
    build

block_connect b02
assert_best b02

comment

# Used contract
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.2;

contract StorageRent {
    StorageRent _anotherContract;
    uint public value;

    event CallSuccess();
    event CallFailure();

    constructor() {
        value = 0;
    }

    function setAnotherContract(address anotherContractAddress) public {
        _anotherContract = StorageRent(anotherContractAddress);
    }

    function changeState() public {
        if(value == 1) {
            value = 0;
        } else {
            value = 1;
        }
    }

    function changeStateAndRevert() public {
        changeState();
        revert("change state and revert");
    }

    function triggerRevert() public {
        revert("trigger revert");
    }

    // Test cases

    function nestedCallHandledFail() public {
        _anotherContract.changeState();

        // trigers a revert but continues with the execution
        (bool success, bytes memory data) = address(_anotherContract).call{gas: 9000}(
            abi.encodeWithSignature("changeStateAndRevert()")
        );

        if(success) {
            emit CallSuccess();
        } else {
            emit CallFailure();
        }

        changeState();
    }

    function nestedCallUnhandledFail() public {
        _anotherContract.changeState();
        // triggers a revert and stops the execution
        _anotherContract.triggerRevert();
        changeState();
    }

    function nestedCallSuccessOveralFails() public {
        _anotherContract.changeState();
        changeState();
        triggerRevert();
    }

    function nestedCallSuccessOveralSuccess() public {
        _anotherContract.changeState();
        changeState();
    }
}

end
